syntax = "proto3";

package op.mcp.v1;

// MCP Service - JSON-RPC over gRPC
service McpService {
  // Unary request/response (standard MCP calls)
  rpc Call(McpRequest) returns (McpResponse);
  
  // Server streaming for SSE-like behavior
  rpc Subscribe(SubscribeRequest) returns (stream McpEvent);
  
  // Bidirectional streaming for full duplex
  rpc Stream(stream McpRequest) returns (stream McpResponse);
  
  // Health check
  rpc Health(HealthRequest) returns (HealthResponse);
  
  // Initialize session (run-on-connection agents)
  rpc Initialize(InitializeRequest) returns (InitializeResponse);
  
  // Tool operations
  rpc ListTools(ListToolsRequest) returns (ListToolsResponse);
  rpc CallTool(CallToolRequest) returns (CallToolResponse);
  rpc CallToolStreaming(CallToolRequest) returns (stream ToolOutput);
}

// Generic MCP JSON-RPC request (passthrough)
message McpRequest {
  string jsonrpc = 1;  // Always "2.0"
  optional string id = 2;
  string method = 3;
  optional string params_json = 4;  // JSON-encoded params
}

// Generic MCP JSON-RPC response
message McpResponse {
  string jsonrpc = 1;
  optional string id = 2;
  optional string result_json = 3;  // JSON-encoded result
  optional McpError error = 4;
}

message McpError {
  int32 code = 1;
  string message = 2;
  optional string data_json = 3;
}

// Subscribe to server events
message SubscribeRequest {
  repeated string event_types = 1;  // "tools", "agents", "resources"
  optional string session_id = 2;
}

message McpEvent {
  string event_type = 1;
  string data_json = 2;
  int64 timestamp = 3;
  uint32 sequence = 4;
}

// Health check
message HealthRequest {}

message HealthResponse {
  bool healthy = 1;
  string version = 2;
  string server_name = 3;
  ServerMode mode = 4;
  repeated string connected_agents = 5;
  uint64 uptime_secs = 6;
}

enum ServerMode {
  SERVER_MODE_UNKNOWN = 0;
  SERVER_MODE_COMPACT = 1;
  SERVER_MODE_AGENTS = 2;
  SERVER_MODE_FULL = 3;
}

// Initialize session
message InitializeRequest {
  string client_name = 1;
  optional string client_version = 2;
  optional string session_id = 3;
  repeated string capabilities = 4;
}

message InitializeResponse {
  string protocol_version = 1;
  string server_name = 2;
  string server_version = 3;
  repeated string capabilities = 4;
  repeated string started_agents = 5;  // Run-on-connection agents
  string session_id = 6;
}

// Tool listing
message ListToolsRequest {
  optional string category = 1;
  optional string query = 2;
  uint32 limit = 3;
  uint32 offset = 4;
}

message ListToolsResponse {
  repeated ToolInfo tools = 1;
  uint32 total = 2;
  bool has_more = 3;
}

message ToolInfo {
  string name = 1;
  string description = 2;
  string input_schema_json = 3;
  optional string category = 4;
  repeated string tags = 5;
}

// Tool execution
message CallToolRequest {
  string tool_name = 1;
  string arguments_json = 2;
  optional string session_id = 3;
  optional uint32 timeout_ms = 4;
}

message CallToolResponse {
  bool success = 1;
  string result_json = 2;
  optional string error = 3;
  uint64 duration_ms = 4;
}

// Streaming tool output
message ToolOutput {
  OutputType output_type = 1;
  string content = 2;
  uint32 sequence = 3;
  bool is_final = 4;
  optional int32 exit_code = 5;
}

enum OutputType {
  OUTPUT_TYPE_UNKNOWN = 0;
  OUTPUT_TYPE_STDOUT = 1;
  OUTPUT_TYPE_STDERR = 2;
  OUTPUT_TYPE_PROGRESS = 3;
  OUTPUT_TYPE_RESULT = 4;
  OUTPUT_TYPE_ERROR = 5;
}
